
{% extends "base.html" %}

{% block title %}{{ document.titulo }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <!-- Header com informações do documento -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-file-earmark-text text-primary"></i> {{ document.titulo }}</h2>
                    <p class="text-muted mb-0">
                        <span class="badge bg-secondary">{{ document.codigo }}</span>
                        <span class="badge bg-info">{{ document.tipo }}</span>
                        <span class="badge bg-{% if document.status == 'aprovado' %}success{% elif document.status == 'rascunho' %}secondary{% elif document.status == 'em_revisao' %}warning{% else %}danger{% endif %}">
                            {% if document.status == 'aprovado' %}
                                <i class="bi bi-check-circle"></i> Aprovado
                            {% elif document.status == 'rascunho' %}
                                <i class="bi bi-pencil"></i> Rascunho
                            {% elif document.status == 'em_revisao' %}
                                <i class="bi bi-clock"></i> Em Revisão
                            {% else %}
                                <i class="bi bi-x-circle"></i> {{ document.status }}
                            {% endif %}
                        </span>
                    </p>
                </div>
                <div>
                    {% if current_user.can_create_documents() or document.autor_id == current_user.id %}
                        <a href="{{ url_for('documents.edit', id=document.id) }}" class="btn btn-outline-warning">
                            <i class="bi bi-pencil"></i> Editar
                        </a>
                    {% endif %}
                    <a href="{{ url_for('documents.export_pdf', id=document.id) }}" class="btn btn-outline-danger">
                        <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
                    </a>
                    <a href="{{ url_for('documents.versions', id=document.id) }}" class="btn btn-outline-info">
                        <i class="bi bi-clock-history"></i> Histórico
                    </a>
                    <a href="{{ url_for('documents.index') }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </a>
                </div>
            </div>

            <div class="row">
                <!-- Conteúdo Principal -->
                <div class="col-md-8">
                    <!-- Conteúdo do Documento -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="bi bi-file-text"></i> Conteúdo do Documento</h5>
                        </div>
                        <div class="card-body">
                            {% if current_version and current_version.conteudo %}
                                <div class="document-content">
                                    {{ current_version.conteudo | safe }}
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="bi bi-file-earmark display-1 text-muted"></i>
                                    <h5 class="mt-3">Conteúdo não disponível</h5>
                                    <p class="text-muted">O conteúdo deste documento ainda não foi definido.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Confirmação de Leitura -->
                    {% if document.status == 'aprovado' %}
                    <div class="card">
                        <div class="card-body text-center">
                            <h6><i class="bi bi-check2-square"></i> Confirmação de Leitura</h6>
                            <p class="text-muted">Confirme que leu e compreendeu este documento.</p>
                            <button type="button" class="btn btn-primary" id="confirm-reading-btn" data-document-id="{{ document.id }}">
                                <i class="bi bi-check-circle"></i> Confirmar Leitura
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Sidebar com Informações -->
                <div class="col-md-4">
                    <!-- Informações Básicas -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6><i class="bi bi-info-circle"></i> Informações do Documento</h6>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-5">Autor:</dt>
                                <dd class="col-sm-7">{{ document.autor.nome_completo if document.autor else '—' }}</dd>

                                <dt class="col-sm-5">Tipo:</dt>
                                <dd class="col-sm-7">{{ document.tipo }}</dd>

                                <dt class="col-sm-5">Departamento:</dt>
                                <dd class="col-sm-7">{{ document.departamento or '—' }}</dd>

                                <dt class="col-sm-5">Versão:</dt>
                                <dd class="col-sm-7">{{ document.versao_atual }}</dd>

                                <dt class="col-sm-5">Criado em:</dt>
                                <dd class="col-sm-7">{{ document.data_criacao.strftime('%d/%m/%Y às %H:%M') if document.data_criacao else '—' }}</dd>

                                {% if document.data_ultima_revisao %}
                                <dt class="col-sm-5">Última revisão:</dt>
                                <dd class="col-sm-7">{{ document.data_ultima_revisao.strftime('%d/%m/%Y às %H:%M') }}</dd>
                                {% endif %}

                                {% if document.data_validade %}
                                <dt class="col-sm-5">Validade:</dt>
                                <dd class="col-sm-7">
                                    <span class="{% if document.is_expired() %}text-danger{% elif document.days_to_expire() and document.days_to_expire() <= 30 %}text-warning{% else %}text-success{% endif %}">
                                        {{ document.data_validade.strftime('%d/%m/%Y') }}
                                        {% if document.is_expired() %}
                                            <i class="bi bi-exclamation-triangle text-danger"></i>
                                        {% elif document.days_to_expire() and document.days_to_expire() <= 30 %}
                                            <i class="bi bi-clock text-warning"></i>
                                        {% endif %}
                                    </span>
                                </dd>
                                {% endif %}
                            </dl>
                        </div>
                    </div>

                    <!-- Resumo -->
                    {% if document.resumo %}
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6><i class="bi bi-file-text"></i> Resumo</h6>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-0">{{ document.resumo }}</p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Palavras-chave -->
                    {% if document.palavras_chave %}
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6><i class="bi bi-tags"></i> Palavras-chave</h6>
                        </div>
                        <div class="card-body">
                            {% for palavra in document.palavras_chave.split(',') %}
                                <span class="badge bg-light text-dark me-1 mb-1">{{ palavra.strip() }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Status de Aprovação -->
                    {% if document.status != 'rascunho' %}
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6><i class="bi bi-check-circle"></i> Status de Aprovação</h6>
                        </div>
                        <div class="card-body">
                            {% if document.fluxos_aprovacao %}
                                {% for fluxo in document.fluxos_aprovacao %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <small class="text-muted">{{ fluxo.responsavel.nome_completo if fluxo.responsavel else 'N/A' }}</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-{% if fluxo.status == 'aprovado' %}success{% elif fluxo.status == 'rejeitado' %}danger{% else %}warning{% endif %}">
                                            {{ fluxo.status }}
                                        </span>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted mb-0">Nenhuma aprovação registrada</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Estatísticas de Leitura -->
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="bi bi-eye"></i> Leituras</h6>
                        </div>
                        <div class="card-body text-center">
                            <h4 class="text-primary">{{ document.leituras.count() }}</h4>
                            <p class="text-muted mb-0">Leituras confirmadas</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.document-content {
    line-height: 1.6;
    font-size: 1rem;
}

.document-content h1, .document-content h2, .document-content h3 {
    margin-top: 1.5rem;
    margin-bottom: 1rem;
}

.document-content p {
    margin-bottom: 1rem;
}

.document-content ul, .document-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.badge {
    font-size: 0.75rem;
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
// Confirmação de leitura de documento
document.addEventListener('DOMContentLoaded', function() {
    const confirmReadingBtn = document.getElementById('confirm-reading-btn');
    if (confirmReadingBtn) {
        confirmReadingBtn.addEventListener('click', function() {
            const documentId = this.dataset.documentId;
            
            fetch(`/documents/${documentId}/confirm_reading`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.innerHTML = '<i class="bi bi-check-circle"></i> Leitura Confirmada';
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-success');
                    this.disabled = true;
                    
                    // Mostrar mensagem de sucesso
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show mt-3';
                    alert.innerHTML = `
                        ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    this.parentElement.appendChild(alert);
                } else {
                    // Mostrar mensagem de aviso
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-warning alert-dismissible fade show mt-3';
                    alert.innerHTML = `
                        ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    this.parentElement.appendChild(alert);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger alert-dismissible fade show mt-3';
                alert.innerHTML = `
                    Erro ao confirmar leitura
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                this.parentElement.appendChild(alert);
            });
        });
    }
});

// Função para obter CSRF token (se necessário)
function getCsrfToken() {
    const token = document.querySelector('meta[name="csrf-token"]');
    return token ? token.getAttribute('content') : '';
}
</script>
{% endblock %}
