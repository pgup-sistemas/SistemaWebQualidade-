1:{% extends "base.html" %}
2:
3:{% block title %}Criar Documento - Alpha Gestão Documental{% endblock %}
4:
5:{% block extra_head %}
6:<!-- Quill.js Editor -->
7:<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
8:<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
9:<style>
10:    #editor-container .ql-editor {
11:        min-height: 400px;
12:        max-height: 600px;
13:    }
14:    .editor-wrapper {
15:        border: 1px solid #ced4da;
16:        border-radius: 0.375rem;
17:    }
18:    .editor-wrapper .ql-toolbar {
19:        border-top: none;
20:        border-left: none;
21:        border-right: none;
22:        border-bottom: 1px solid #ced4da;
23:    }
24:    .editor-wrapper .ql-container {
25:        border: none;
26:    }
27:</style>
28:{% endblock %}
29:
30:{% block content %}
31:<div class="container-fluid py-4">
32:    <div class="row">
33:        <div class="col-12">
34:            <div class="d-flex justify-content-between align-items-center mb-4">
35:                <h1 class="h3">
36:                    <i class="bi bi-file-earmark-plus"></i> Criar Novo Documento
37:                    <small class="text-muted">Editor integrado de documentos</small>
38:                </h1>
39:                <a href="{{ url_for('documents.index') }}" class="btn btn-outline-secondary">
40:                    <i class="bi bi-arrow-left"></i> Voltar
41:                </a>
42:            </div>
43:        </div>
44:    </div>
45:
46:    <form method="POST" class="needs-validation" novalidate id="documentForm">
47:        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
48:        <div class="row">
49:            <!-- Informações do Documento -->
50:            <div class="col-md-4">
51:                <div class="card">
52:                    <div class="card-header">
53:                        <h6 class="card-title mb-0">
54:                            <i class="bi bi-info-circle"></i> Informações do Documento
55:                        </h6>
56:                    </div>
57:                    <div class="card-body">
58:                        <div class="mb-3">
59:                            <label for="titulo" class="form-label">Título *</label>
60:                            <input type="text" class="form-control" id="titulo" name="titulo" required>
61:                            <div class="invalid-feedback">
62:                                O título é obrigatório.
63:                            </div>
64:                        </div>
65:
66:                        <div class="mb-3">
67:                            <label for="tipo" class="form-label">Tipo *</label>
68:                            <div class="d-flex">
69:                                <select class="form-select me-2" id="tipo" name="tipo" required>
70:                                    <option value="">Selecione o tipo</option>
71:                                    {% for doc_type in document_types %}
72:                                    <option value="{{ doc_type.codigo }}" data-id="{{ doc_type.id }}">
73:                                        {{ doc_type.nome }}
74:                                    </option>
75:                                    {% endfor %}
76:                                    <!-- Tipos padrão para compatibilidade -->
77:                                    <option value="procedimento">Procedimento</option>
78:                                    <option value="instrucao">Instrução de Trabalho</option>
79:                                    <option value="politica">Política</option>
80:                                    <option value="manual">Manual</option>
81:                                    <option value="formulario">Formulário</option>
82:                                    <option value="plano">Plano</option>
83:                                    <option value="registro">Registro</option>
84:                                    <option value="outros">Outros</option>
85:                                </select>
86:                            </div>
87:                            <input type="hidden" id="tipo_documento_id" name="tipo_documento_id">
88:                            <div class="invalid-feedback">
89:                                Selecione o tipo do documento.
90:                            </div>
91:                        </div>
92:
93:                        <div class="mb-3">
94:                            <label for="departamento" class="form-label">Departamento</label>
95:                            <input type="text" class="form-control" id="departamento" name="departamento"
96:                                   placeholder="Ex: Qualidade, RH, Produção">
97:                        </div>
98:
99:                        <div class="mb-3">
100:                            <label for="data_validade" class="form-label">Data de Validade</label>
101:                            <input type="date" class="form-control" id="data_validade" name="data_validade">
102:                            <div class="form-text">Deixe em branco se não há validade definida</div>
103:                        </div>
104:
105:                        <div class="mb-3">
106:                            <label for="palavras_chave" class="form-label">Palavras-chave</label>
107:                            <input type="text" class="form-control" id="palavras_chave" name="palavras_chave"
108:                                   placeholder="Ex: qualidade, auditoria, ISO">
109:                            <div class="form-text">Separadas por vírgula para facilitar a busca</div>
110:                        </div>
111:
112:                        <div class="mb-3">
113:                            <label for="resumo" class="form-label">Resumo</label>
114:                            <textarea class="form-control" id="resumo" name="resumo" rows="3"
115:                                      placeholder="Breve descrição do documento"></textarea>
116:                        </div>
117:                    </div>
118:                </div>
119:            </div>
120:
121:            <!-- Editor de Conteúdo -->
122:            <div class="col-md-8">
123:                <div class="card">
124:                    <div class="card-header">
125:                        <h6 class="card-title mb-0">
126:                            <i class="bi bi-file-text"></i> Conteúdo do Documento
127:                        </h6>
128:                    </div>
129:                    <div class="card-body">
130:                        <div class="mb-3">
131:                            <label class="form-label">Conteúdo *</label>
132:
133:                            <!-- Editor Container -->
134:                            <div id="quill-editor" style="height: 400px; border: 1px solid #ced4da; border-radius: 0.375rem;"></div>
135:
136:                            <!-- Campo oculto para submissão -->
137:                            <textarea id="conteudo" name="conteudo" required style="display: none;"></textarea>
138:
139:                            <div class="invalid-feedback">
140:                                O conteúdo é obrigatório.
141:                            </div>
142:                        </div>
143:
144:                        <div class="d-flex justify-content-between">
145:                            <div>
146:                                <small class="text-muted">
147:                                    <i class="bi bi-info-circle"></i>
148:                                    Use o editor acima para formatar o documento.
149:                                </small>
150:                            </div>
151:                            <div>
152:                                <button type="submit" name="action" value="submit" class="btn btn-primary me-2" id="btn-criar">
153:                                    <i class="bi bi-check-circle"></i> Criar Documento
154:                                </button>
155:                                <button type="submit" name="action" value="draft" class="btn btn-outline-warning" id="btn-rascunho">
156:                                    <i class="bi bi-file-earmark"></i> Salvar Rascunho
157:                                </button>
158:                            </div>
159:                        </div>
160:                    </div>
161:                </div>
162:            </div>
163:        </div>
164:    </form>
165:</div>
166:
167:<!-- Modal para Criar Novo Tipo -->
168:<div class="modal fade" id="newTypeModal" tabindex="-1">
169:    <div class="modal-dialog">
170:        <div class="modal-content">
171:            <div class="modal-header">
172:                <h5 class="modal-title">Criar Novo Tipo de Documento</h5>
173:                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
174:            </div>
175:            <div class="modal-body">
176:                <form id="newTypeForm">
177:                    <div class="mb-3">
178:                        <label for="newTipoCodigo" class="form-label">Código *</label>
179:                        <input type="text" class="form-control" id="newTipoCodigo"
180:                               pattern="[A-Z0-9-]+" maxlength="20"
181:                               placeholder="Ex: LAB, CERT, PROC">
182:                        <div class="form-text">Apenas letras maiúsculas, números e hífens</div>
183:                    </div>
184:                    <div class="mb-3">
185:                        <label for="newTipoNome" class="form-label">Nome *</label>
186:                        <input type="text" class="form-control" id="newTipoNome"
187:                               maxlength="100"
188:                               placeholder="Ex: Certificação Laboratorial">
189:                    </div>
190:                </form>
191:            </div>
192:            <div class="modal-footer">
193:                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
194:                <button type="button" class="btn btn-primary" onclick="createNewType()">
195:                    <i class="bi bi-check-circle"></i> Criar
196:                </button>
197:            </div>
198:        </div>
199:    </div>
200:</div>
201:{% endblock %}
202:
203:{% block extra_scripts %}
204:<script>
205:// Variável global para o editor Quill
206:let quill;
207:
208:document.addEventListener('DOMContentLoaded', function() {
209:    console.log('Inicializando Quill Editor...');
210:
211:    // Verificar se Quill está disponível
212:    if (typeof Quill === 'undefined') {
213:        console.error('Quill.js não foi carregado!');
214:        alert('Erro: Editor de texto não carregado. Recarregue a página.');
215:        return;
216:    }
217:
218:    try {
219:        // Inicializar Quill Editor
220:        quill = new Quill('#quill-editor', {
221:            theme: 'snow',
222:            placeholder: 'Digite o conteúdo do documento aqui...',
223:            modules: {
224:                toolbar: [
225:                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
226:                    ['bold', 'italic', 'underline', 'strike'],
227:                    [{ 'color': [] }, { 'background': [] }],
228:                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
229:                    [{ 'indent': '-1'}, { 'indent': '+1' }],
230:                    [{ 'align': [] }],
231:                    ['link', 'image'],
232:                    ['clean']
233:                ]
234:            }
235:        });
236:
237:        console.log('Quill inicializado com sucesso!');
238:
239:        // Campo oculto para envio
240:        const hiddenInput = document.getElementById('conteudo');
241:
242:        // Sincronizar conteúdo com campo oculto
243:        quill.on('text-change', function() {
244:            const content = quill.root.innerHTML;
245:            hiddenInput.value = content;
246:            console.log('Conteúdo atualizado:', content.length, 'caracteres');
247:        });
248:
249:        // Validação do formulário
250:        document.getElementById('documentForm').addEventListener('submit', function(e) {
251:            // Sincronizar conteúdo antes do envio
252:            const content = quill.root.innerHTML;
253:            hiddenInput.value = content;
254:
255:            // Verificar se há conteúdo
256:            const textContent = quill.getText().trim();
257:            if (!textContent || textContent.length < 10) {
258:                e.preventDefault();
259:                alert('O conteúdo deve ter pelo menos 10 caracteres');
260:                quill.focus();
261:                return false;
262:            }
263:
264:            // Verificar título
265:            const titulo = document.getElementById('titulo').value.trim();
266:            if (!titulo) {
267:                e.preventDefault();
268:                alert('O título é obrigatório');
269:                document.getElementById('titulo').focus();
270:                return false;
271:            }
272:
273:            // Verificar tipo
274:            const tipo = document.getElementById('tipo').value;
275:            if (!tipo) {
276:                e.preventDefault();
277:                alert('Selecione o tipo do documento');
278:                document.getElementById('tipo').focus();
279:                return false;
280:            }
281:
282:            console.log('Formulário válido, enviando...');
283:        });
284:
285:        // Form validation Bootstrap
286:        const forms = document.querySelectorAll('.needs-validation');
287:        forms.forEach(function(form) {
288:            form.addEventListener('submit', function(event) {
289:                if (!form.checkValidity()) {
290:                    event.preventDefault();
291:                    event.stopPropagation();
292:                }
293:                form.classList.add('was-validated');
294:            });
295:        });
296:
297:    } catch (error) {
298:        console.error('Erro ao inicializar Quill:', error);
299:        alert('Erro ao inicializar o editor. Recarregue a página.');
300:    }
301:});
302:
303:// Gerenciar tipos de documento
304:document.addEventListener('DOMContentLoaded', function() {
305:    document.getElementById('tipo').addEventListener('change', function() {
306:        const selectedOption = this.options[this.selectedIndex];
307:        const tipoDocumentoId = selectedOption.getAttribute('data-id');
308:        document.getElementById('tipo_documento_id').value = tipoDocumentoId || '';
309:    });
310:});
311:</script>
312:{% endblock %}